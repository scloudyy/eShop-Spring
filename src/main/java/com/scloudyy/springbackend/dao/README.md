# 读写分离

MySQL配置主从数据库后，需要配置Spring和Mybatis使其向从库请求读操作，向主库请求写操作或者任何事物操作（事物涉及读写）

在之前的配置中只有一个dataSource，指向一个数据库。为了实现读写分离，首先编写DynamicDataSource类，其继承AbstractRoutingDataSource，是一个具有路由功能的抽象DataSource。实现其继承AbstractRoutingDataSource中的determineCurrentLookupKey方法该类就能够在每次需要连接数据库时根据返回的lookupKey连接不同的数据库。

determineCurrentLookupKey方法直接向DynamicDataSourceHolder查询并放回lookupKey。DynamicDataSourceHolder主要维护一个ThreadLocal变量，里面存放了当前的lookupKey，该变量时线程安全的。

DynamicDataSourceHolder里的lookupKey是由DynamicDataSourceInterceptor来更新的，其继承了Mybatis的拦截器Interceptor。当有新的Mybatis请求发起时，拦截器会拦截该请求，并判断该请求时读操作还是写操作，以此更新DynamicDataSourceHolder。

在spring-dao.xml中，首先分别配置主从库的bean，然后添加DynamicDataSource类的bean，并将主从库的bean作为参数注入targetDataSources这一map中。最后将DynamicDataSource的bean注入LazyConnectionDataSourceProxy的bean中作为真正的dataSource，因为只有等到SQL语句正式执行时才能指定dataSource，所以需要懒加载

在mybatis-config.xml中，需要将DynamicDataSourceInterceptor配置为Mybatis的plugin。